<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memory Math - Jogo</title>
    <link href="https://nostalgic-css.github.io/NES.css/style.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/nes.css/css/nes-core.min.css" rel="stylesheet" />
    <link href="./assets/style/style.css" rel="stylesheet" />
    <style>
        
    </style>
    <script>
        let regras = JSON.parse(localStorage.getItem("regras"));
        /*
            *To do
            * Verificar aqui se jogador está logado
            * Fazer fetch enviando quantidade de cartas de acordo com a dificuldade            
        */

        let cartas = [
            {"key":2, "value" : "25"},
            {"key":0, "value" : "21"},
            {"key":1, "value" : "2+2"},
            {"key":0, "value" : "3 * 7"},
            {"key":2, "value" : "5 * 5"},
            {"key":1, "value" : "4"}
        ]

    </script>
</head>
<body>
    <div class="nescss">
        <header class="">
            <div class="container">
                <div class="nav-brand">
                    <a href="https://nostalgic-css.github.io/NES.css/">
                        <h1><i class="snes-jp-logo brand-logo"></i>Game</h1>
                    </a>
                    <p>Memory Math</p>
                </div>
                <div class="social-buttons">
                    <p>Jogo</p>
                </div>
            </div>
        </header>
        <p class="pontuacao">
            <span id="pontuacaoAtual" class="nes-text is-primary">0</span>
        </p>
        <div class="nes-container with-title is-centered">
            <p class="title" id="timerCounter"></p>
        </div>
        <section>
            <button type="button" class="nes-btn is-primary" onclick="document.getElementById('dialog-rounded').showModal();">
              Open rounded dialog
            </button>
            <dialog class="nes-dialog is-rounded" id="dialog-rounded">
              <form method="dialog">
                <p class="title">Pergunta:</p>
                <p id="pergunta">texto aqui!</p>
                <input type="text" required id="dark_field" class="nes-input is-dark" placeholder="Qual a resposta?">
                <menu class="dialog-menu">
                  <button class="nes-btn" onclick="document.getElementById('dialog-rounded').close();">Pular</button>
                  <button type="submit" class="nes-btn is-primary">Responder</button>
                </menu>
              </form>
            </dialog>
          </section>

    </div>
    <script lang="text/javascript">
        let timer = document.querySelector('#timerCounter');
        let timerCounter = regras.timer * 1000;
        let primeiraJogada = null;
        let quantidadeCartasAtivas = cartas.length / 2;

        let startTimer = () => {
            setTimeout(() => {
                timer.textContent = timerCounter/1000;
                timerCounter -= 1000;
                if(timerCounter < 0){
                    alert("Você perdeu. Fim de jogo!");
                    //Soma pontos totais
                    //Envia para o ranking
                    window.location.href = "index.html";
                    return;
                }
                startTimer();
            },1000)
        }
        startTimer();
        
        let registrarPontuacao = (pontos) => {
            let pontuacaoAtual = parseInt(localStorage.getItem("pontuacaoAtual")) + pontos;
            localStorage.setItem("pontuacaoAtual", pontuacaoAtual);

            document.querySelector('#pontuacaoAtual').textContent = pontuacaoAtual; 
        }
        registrarPontuacao(0);

        let verificaFimDaEtapa = () => {            
            if(quantidadeCartasAtivas <= 0){
                registrarPontuacao(regras.pontuacaoPorEtapa);
                alert("Fim da etapa");
                window.location.reload();
            }
        }

        let verificaSeCartasSaoIguais = (card1, card2, callback) => new Promise((resolve, reject) => {
            if(card1.getAttribute("key") == card2.getAttribute("key")){
                registrarPontuacao(10);
                quantidadeCartasAtivas--;
                resolve();
            }else{
                card1.className = "card";
                card2.className = "card";
                resolve();
            }
        });

        let makeMove = (card) => {
            card.className += " show"
            
            if(!primeiraJogada){
                primeiraJogada = card;
                return;
            }
            
            setTimeout(async () => {
                await verificaSeCartasSaoIguais(primeiraJogada, card);                    
                verificaFimDaEtapa();                
                primeiraJogada = null;
                card = null;
            },350)
            
        }

        let makeElement = (text, key) => {
            let newCard = document.createElement('div');
            newCard.classList = "card";
            newCard.textContent = text;
            newCard.setAttribute('key', key);
            newCard.addEventListener('click',(el) => {
                makeMove(el.target)
            });
            containerElement.appendChild(newCard);
        }

        let containerElement = document.querySelector('.nes-container');
        cartas.forEach((obj) => {
            makeElement(obj.value, obj.key);
        });


    </script>
</body>
</html>