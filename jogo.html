<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memory Math - Jogo</title>
    <link href="https://nostalgic-css.github.io/NES.css/style.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/nes.css/css/nes-core.min.css" rel="stylesheet" />
    <link href="./assets/style/style.css" rel="stylesheet" />
    <style>
        
    </style>
    <script>
        let regras = JSON.parse(localStorage.getItem("regras"));
        /*
            *To do
            * Verificar aqui se jogador está logado
            * Fazer fetch enviando quantidade de cartas de acordo com a dificuldade            
        */
        let dadosFormulariosCapturarCartas = new FormData();
        dadosFormulariosCapturarCartas.append('qtdCartas',regras.qtdCartas);
        let params = {
            method: 'POST',
            body: dadosFormulariosCapturarCartas
        };
        let cartas = null;
        fetch("./backend/selecionarcartas.php",params).then((response) => {
            response.json().then((jsonReturn) => {
                console.log(jsonReturn);
                if(!jsonReturn){
                    alert('Sem Cartas a exibir')
                    return;
                }
                cartas = jsonReturn;
                startGame();
            });
        });

        let respotaParaPerguntaAleatoria = null;
        fetch("./backend/listarperguntas.php").then((response) => {
            response.json().then((jsonReturn) => {
                console.log(jsonReturn);
                document.getElementById('pergunta').textContent = jsonReturn.PERGUNTA;
                respotaParaPerguntaAleatoria = jsonReturn.RESPOSTA;
            });
        });
     
    </script>
</head>
<body>
    <div class="nescss">
        <header class="">
            <div class="container">
                <div class="nav-brand">
                    <a href="https://nostalgic-css.github.io/NES.css/">
                        <h1><i class="snes-jp-logo brand-logo"></i>Game</h1>
                    </a>
                    <p>Memory Math</p>
                </div>
                <div class="social-buttons">
                    <p>Jogo</p>
                </div>
            </div>
        </header>
        <p class="pontuacao">
            <span id="pontuacaoAtual" class="nes-text is-primary">0</span>
        </p>
        <div class="nes-container with-title is-centered">
            <p class="title" id="timerCounter"></p>
        </div>
        <section>
            <button type="button" class="nes-btn is-primary" onclick="document.getElementById('dialog-rounded').showModal();">
              Open rounded dialog
            </button>
            <dialog class="nes-dialog is-rounded" id="dialog-rounded">
              <form method="dialog">
                <p class="title">Pergunta:</p>
                <p id="pergunta">texto aqui!</p>
                <input type="text" id="inputPergunta" required id="dark_field" class="nes-input is-dark" placeholder="Qual a resposta?">
                <menu class="dialog-menu">
                  <button class="nes-btn" onclick="document.getElementById('dialog-rounded').close();">Pular</button>
                  <button type="submit" class="nes-btn is-primary" onclick="respondePerguntaAleatoria()">Responder</button>
                </menu>
              </form>
            </dialog>
          </section>

    </div>
    <script lang="text/javascript">
    let startGame = () => {
        let timer = document.querySelector('#timerCounter');
        let timerCounter = regras.timer * 1000;
        let tempoPerguntaAleatoria = Math.floor(Math.random() * (regras.timer - 10) + 10);
        let primeiraJogada = null;
        let quantidadeCartasAtivas = cartas.length / 2;
        let timerIntervalValue = null;
        let startTimer = () => {
            timerIntervalValue = setInterval(() => {
                if((tempoPerguntaAleatoria * 1000) == timerCounter){
                    clearInterval(timerIntervalValue);
                    document.getElementById('dialog-rounded').showModal();
                }
                timer.textContent = timerCounter/1000;
                timerCounter -= 1000;

                if(timerCounter < 0){
                    clearInterval(timerIntervalValue);
                    alert("Você perdeu. Fim de jogo!");
                    //Soma pontos totais
                    //Envia para o ranking
                    window.location.href = "index.html";
                    return;
                }
            },1000)
        }
        startTimer();

        let registrarPontuacao = (pontos) => {
            let pontuacaoAtual = parseInt(localStorage.getItem("pontuacaoAtual")) + pontos;
            localStorage.setItem("pontuacaoAtual", pontuacaoAtual);

            document.querySelector('#pontuacaoAtual').textContent = pontuacaoAtual; 
        }
        registrarPontuacao(0);

        let verificaFimDaEtapa = () => {            
            if(quantidadeCartasAtivas <= 0){
                registrarPontuacao(regras.pontuacaoPorEtapa);
                alert("Fim da etapa");
                window.location.reload();
            }
        }

        let verificaSeCartasSaoIguais = (card1, card2, callback) => new Promise((resolve, reject) => {
            if(card1.getAttribute("key") == card2.getAttribute("key")){
                registrarPontuacao(10);
                quantidadeCartasAtivas--;
                resolve();
            }else{
                card1.className = "card";
                card2.className = "card";
                resolve();
            }
        });

        let makeMove = (card) => {
            card.className += " show"
            
            if(!primeiraJogada){
                primeiraJogada = card;
                return;
            }
            
            setTimeout(async () => {
                await verificaSeCartasSaoIguais(primeiraJogada, card);                    
                verificaFimDaEtapa();                
                primeiraJogada = null;
                card = null;
            },350)
            
        }

        let makeElement = (text, key) => {
            let newCard = document.createElement('div');
            newCard.classList = "card";
            newCard.textContent = text;
            newCard.setAttribute('key', key);
            newCard.addEventListener('click',(el) => {
                makeMove(el.target)
            });
            containerElement.appendChild(newCard);
        }

        let containerElement = document.querySelector('.nes-container');
        cartas.forEach((obj) => {
            makeElement(obj.value, obj.key);
        });

        let respondePerguntaAleatoria = () => {
            let resposta = document.querySelector('#inputPergunta').value;
            if(resposta === respotaParaPerguntaAleatoria){
                let arrayCartasNaoSelecionadas = Array.from(document.querySelectorAll(".card")).filter(item => !item.classList[1]);
                if(arrayCartasNaoSelecionadas.length <= 2){
                    startTimer();
                    return;
                }                
                arrayCartasNaoSelecionadas[0].className += " show";
                let atributoKeyPrimeiraCarta = arrayCartasNaoSelecionadas[0].getAttribute("key");
                for(i = 1; i < arrayCartasNaoSelecionadas.length; i++){
                    if(atributoKeyPrimeiraCarta == arrayCartasNaoSelecionadas[i].getAttribute("key")){
                        arrayCartasNaoSelecionadas[i].className += " show";
                        registrarPontuacao(10);
                        quantidadeCartasAtivas--;
                        verificaFimDaEtapa();
                    }
                }
            }
            startTimer();
        }
    }
    </script>
</body>
</html>