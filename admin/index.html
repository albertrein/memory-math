<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Página de Administração</title>
    <link href="https://nostalgic-css.github.io/NES.css/style.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/nes.css/css/nes-core.min.css" rel="stylesheet" />
    <link href="../assets/style/style.css" rel="stylesheet" />
</head>
<body>
    <div class="nescss">
        <header class="">
            <div class="container">
                <div class="nav-brand">
                    <a href="https://nostalgic-css.github.io/NES.css/">
                        <h1><i class="snes-jp-logo brand-logo"></i>Game</h1>
                    </a>
                    <p>Memory Math</p>
                </div>
                <div class="social-buttons">
                    <div class="share">
                        <a href="manter_cartas.html" class="nes-badge">
                            <span class="is-dark">Cartas</span>
                        </a>
                        <a href="manter_perguntas.html" class="nes-badge">
                            <span class="is-dark">Perguntas</span>
                        </a>
                        <a href="manter_contas.html" class="nes-badge">
                            <span class="is-dark">Contas</span>
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <div class="nes-table-responsive">
          <table class="nes-table is-bordered is-centered">
            <thead>
              <tr>
                <th>Valor</th>
                <th>Resultado</th>
                <th>Editar</th>
                <th>Excluir</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <section>
            <dialog class="nes-dialog" id="dialog-default">
              <form id="dialog-form" method="dialog">
                <p class="title">Editando Item: <span id="itemCod"></span></p>
                <p class="_error" style="display: none; color: red;">Verifique os campos!</p>
                <label for="name_field">Campo1:</label>
                <input type="text" id="campo1" class="nes-input">
                <label for="name_field">Campo2</label>
                <input type="text" id="campo2" class="nes-input">
                <menu class="dialog-menu">
                  <button class="nes-btn" onclick="document.getElementById('dialog-default').close();">Cancelar</button>
                  <button class="nes-btn is-primary" onclick="atualizaDados(document.querySelector('#itemCod').textContent);">Salvar!</button>
                </menu>
              </form>
            </dialog>
          </section>
          
    </div>
    <script src="../js/geradorElementosTabela.js"></script>
    <script>
        let x = document.querySelector('tbody');
        fetch("../backend/crud-cartas.php").then(response => {
            response.json().then((jsonReturn) => {
                if(!jsonReturn){
                    alert('Cartas Vazias!');
                    return;
                }
                console.log(jsonReturn);
                jsonReturn.forEach(element => x.appendChild(getNovoItem(element.id, element.expressao, element.resultado)) );
            });
        });
    
        //Desabilitando formulario submit
        document.querySelector('#dialog-form').addEventListener('submit', event => event.preventDefault());

        let makeEdit = (codigoLinha) => {
            let cedulaTabela = document.getElementById(codigoLinha);
            let arrayCamposCedula = cedulaTabela.querySelectorAll('td');
            document.querySelector('#campo1').placeholder = arrayCamposCedula[0].textContent;
            document.querySelector('#campo2').placeholder = arrayCamposCedula[1].textContent;
            
            document.querySelector('#itemCod').textContent = codigoLinha;
            document.getElementById('dialog-default').showModal();

            //Tirando alert de caso anterior
            document.querySelector('#campo1').value = "";
            document.querySelector('#campo2').value = "";
            document.querySelector('._error').style.display = "none";
        }

        let atualizaDados = async (codigoLinha) => {
            let campo1 = sanitizeString(document.querySelector('#campo1').value);
            let campo2 = sanitizeString(document.querySelector('#campo2').value);
            console.log(campo1,campo2)
            if(campo1.length < 1 || campo2 < 1){
                document.querySelector('._error').style.display = "block";
                return;
            }
            
            let response = await realizaRequisicao(codigoLinha,"atualiza",campo1, campo2);
            if(response)
                window.location.reload();
            return;

        }

        let makeDelete = async (codigoLinha) => {
            let response = await realizaRequisicao(codigoLinha,"deleta");
            if(response)
                window.location.reload();
            return;
        };

        let realizaRequisicao = (cod, acao, campo1 = null, campo2 = null) => new Promise((resolve, reject) => {
            let params = {
                method: 'post',
                body: JSON.stringify({'cod':cod, 'acao': acao, 'campo1': campo1, 'campo2': campo2})
            }
            fetch("../backend/crud-cartas.php",parms).then(response => {
                response.json().then((jsonReturn) => {
                    if(!jsonReturn)
                        resolve(false);
                    resolve(true);
                });
            });
        });

        //Limpa string
        function sanitizeString(str){
            str = str.replace(/[^a-z0-9áéíóúñü \.,_-]/gim,"");
            return str.trim();
        }

    </script>
</body>
</html>